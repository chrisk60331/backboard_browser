{% extends "base.html" %}

{% block title %}Dashboard - Backboard Browser{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">Browse and manage your Backboard.io resources</p>
    </div>

    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        <!-- Assistants Card -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='/assistants'">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Assistants</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white hidden" id="assistantsCount">-</div>
                                <div id="assistantsSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 dark:border-blue-400"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Memory Card -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='/memory'">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Memory</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white hidden" id="memoryCount">-</div>
                                <div id="memorySpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-600 dark:border-green-400"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models Card -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="navigateToModels()">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Models</dt>
                            <dd class="flex items-baseline space-x-2">
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white hidden" id="modelsCount">-</div>
                                <div class="text-sm text-gray-500 dark:text-gray-400 hidden" id="modelsProviders">-</div>
                                <div id="modelsSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600 dark:border-purple-400"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents Card -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='/documents'">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Documents</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white hidden" id="documentsCount">-</div>
                                <div id="documentsSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-yellow-600 dark:border-yellow-400"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Threads Card -->
        <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg hover:shadow-lg transition-shadow cursor-pointer" onclick="window.location.href='/threads'">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">Threads</dt>
                            <dd class="flex items-baseline">
                                <div class="text-2xl font-semibold text-gray-900 dark:text-white hidden" id="threadsCount">-</div>
                                <div id="threadsSpinner" class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600 dark:border-red-400"></div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function hideSpinner(spinnerId) {
    const spinner = document.getElementById(spinnerId);
    if (spinner) spinner.classList.add('hidden');
}

function showCount(countId, value) {
    const countEl = document.getElementById(countId);
    if (countEl) {
        countEl.textContent = value;
        countEl.classList.remove('hidden');
    }
}

function navigateToModels() {
    // Use client-side navigation to avoid full page reload
    window.history.pushState({}, '', '/models');
    window.dispatchEvent(new PopStateEvent('popstate'));
    // Also update the URL bar
    window.location.href = '/models';
}

async function loadCounts() {
    try {
        // Load all counts from cache endpoints in parallel
        const [assistantsRes, memoryRes, modelsRes, documentsRes, threadsRes] = await Promise.all([
            fetch('/api/cache/assistants-count').catch(() => ({ok: false})),
            fetch('/api/cache/memory-count').catch(() => ({ok: false})),
            fetch('/api/cache/models-count').catch(() => ({ok: false})),
            fetch('/api/cache/documents-count').catch(() => ({ok: false})),
            fetch('/api/cache/threads-count').catch(() => ({ok: false}))
        ]);

        // Assistants count
        if (assistantsRes.ok) {
            const data = await assistantsRes.json();
            hideSpinner('assistantsSpinner');
            showCount('assistantsCount', data.count || '0');
        } else {
            hideSpinner('assistantsSpinner');
            showCount('assistantsCount', '-');
        }

        // Memory count
        if (memoryRes.ok) {
            const data = await memoryRes.json();
            hideSpinner('memorySpinner');
            showCount('memoryCount', data.count || '0');
        } else {
            hideSpinner('memorySpinner');
            showCount('memoryCount', '-');
        }

        // Models count
        if (modelsRes.ok) {
            const data = await modelsRes.json();
            hideSpinner('modelsSpinner');
            showCount('modelsCount', data.count || '0');
            
            // Show providers count
            if (data.providers > 0) {
                const providersEl = document.getElementById('modelsProviders');
                if (providersEl) {
                    providersEl.textContent = `${data.providers} provider${data.providers !== 1 ? 's' : ''}`;
                    providersEl.classList.remove('hidden');
                }
            }
        } else {
            hideSpinner('modelsSpinner');
            showCount('modelsCount', '-');
        }

        // Documents count
        if (documentsRes.ok) {
            const data = await documentsRes.json();
            hideSpinner('documentsSpinner');
            showCount('documentsCount', data.count || '0');
        } else {
            hideSpinner('documentsSpinner');
            showCount('documentsCount', '-');
        }

        // Threads count
        if (threadsRes.ok) {
            const data = await threadsRes.json();
            hideSpinner('threadsSpinner');
            showCount('threadsCount', data.count || '0');
        } else {
            hideSpinner('threadsSpinner');
            showCount('threadsCount', '-');
        }
    } catch (error) {
        console.error('Error loading counts:', error);
        // Hide all spinners on error
        ['assistantsSpinner', 'memorySpinner', 'modelsSpinner', 'documentsSpinner', 'threadsSpinner'].forEach(hideSpinner);
    }
}

loadCounts();
</script>
{% endblock %}
